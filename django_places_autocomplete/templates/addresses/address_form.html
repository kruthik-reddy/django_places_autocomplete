{% extends "base.html" %}
{% block title %}Enter Address{% endblock %}
{% block body_class %}bg-gray-50 min-h-screen py-8{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4">
  <div class="bg-white rounded-xl shadow-lg p-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Enter Your Address</h2>

    <form id="address-form" method="post" class="space-y-6">
      {% csrf_token %}

      <!-- Google Place Autocomplete element mounts here -->
      <label for="gmp-placeselect" class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
      <div id="autocomplete-wrapper"></div>

      <!-- Hidden model fields -->
      {{ form.street_number }}
      {{ form.route }}
      {{ form.locality }}
      {{ form.administrative_area_level_1 }}
      {{ form.country }}
      {{ form.postal_code }}
      {{ form.latitude }}
      {{ form.longitude }}

      <!-- Live preview -->
      <div id="address-components" class="hidden bg-gray-50 p-4 rounded-lg text-sm grid grid-cols-2 gap-4">
        <div><strong>Address:</strong> <span id="display-formatted"></span></div>
        <div><strong>Street:</strong> <span id="display-street"></span></div>
        <div><strong>City:</strong>   <span id="display-city"></span></div>
        <div><strong>State:</strong>  <span id="display-state"></span></div>
        <div><strong>Country:</strong><span id="display-country"></span></div>
        <div><strong>Postal:</strong> <span id="display-postal"></span></div>
        <div><strong>Coords:</strong> <span id="display-coords"></span></div>
      </div>

      <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-colors font-medium">
        Save Address
      </button>
    </form>

    <div id="message" class="hidden mt-4 p-4 rounded-lg"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- Maps JS v=beta (async) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&v=beta&callback=initGoogle&loading=async"></script>

  <script>
    let gmEl;                     // <gmpx-place-autocomplete>
    const form      = document.getElementById('address-form');
    const msgBox    = document.getElementById('message');
    const preview   = document.getElementById('address-components');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function initGoogle() {
      gmEl = document.createElement('gmpx-place-autocomplete');
      gmEl.id = 'gmp-placeselect';
      gmEl.setAttribute('componentRestrictions', '{"country":["us","ca"]}');
      gmEl.setAttribute('fields', 'addressComponents,formattedAddress,location');
      document.getElementById('autocomplete-wrapper').appendChild(gmEl);
      gmEl.addEventListener('gmpx-place-change', onPlaceChanged);
    }

    function onPlaceChanged(e) {
      const place = e.detail;
      if (!place.location) { show('Pick an address from the list', 'error'); return; }

      const c = Object.fromEntries(place.addressComponents.map(x => [x.types[0], x.longText]));
      set('id_street_number', c.street_number);
      set('id_route', c.route);
      set('id_locality', c.locality);
      set('id_administrative_area_level_1', c.administrative_area_level_1);
      set('id_country', c.country);
      set('id_postal_code', c.postal_code);
      set('id_latitude', place.location.lat);
      set('id_longitude', place.location.lng);

      document.getElementById('display-street').textContent = `${c.street_number||''} ${c.route||''}`.trim();
      document.getElementById('display-city').textContent    = c.locality  || '';
      document.getElementById('display-state').textContent   = c.administrative_area_level_1 || '';
      document.getElementById('display-country').textContent = c.country   || '';
      document.getElementById('display-postal').textContent  = c.postal_code || '';

      const q = place.formattedAddress
        ? {address: place.formattedAddress}
        : {lat: place.location.lat, lng: place.location.lng};
      geocodeAddress(q);
    }

    function set(id, v='') { const el=document.getElementById(id); if(el) el.value = v; }

    function show(msg, type='success') {
      msgBox.textContent = msg;
      msgBox.className = `mt-4 p-4 rounded-lg ${type==='success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
      msgBox.classList.remove('hidden');
      setTimeout(() => msgBox.classList.add('hidden'), 4000);
    }

    async function geocodeAddress(opts) {
      let url = '';
      if (typeof opts === 'string' || (opts && opts.address)) {
        const addr = typeof opts === 'string' ? opts : opts.address;
        url = `/address/geocode/?address=${encodeURIComponent(addr)}`;
      } else if (opts && opts.lat != null && opts.lng != null) {
        url = `/address/geocode/?lat=${encodeURIComponent(opts.lat)}&lng=${encodeURIComponent(opts.lng)}`;
      } else {
        return;
      }

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.results.length) {
          const r = data.results[0];
          document.getElementById('display-formatted').textContent = r.formatted_address || '';
          document.getElementById('display-coords').textContent = `${Number(r.latitude).toFixed(6)}, ${Number(r.longitude).toFixed(6)}`;
          preview.classList.remove('hidden');
        } else {
          preview.classList.add('hidden');
          show(data.error || 'No results found.', 'error');
        }
      } catch (err) {
        preview.classList.add('hidden');
        show('Error fetching address data.', 'error');
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await fetch('', {method:'POST', body:new FormData(form), headers:{'X-CSRFToken': csrfToken}});
      const data = await res.json();
      if (data.success) {
        show(data.message, 'success');
        form.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = '');
        preview.classList.add('hidden');
      } else {
        show('Please correct the errors and try again.', 'error');
      }
    });
  </script>
{% endblock %}
